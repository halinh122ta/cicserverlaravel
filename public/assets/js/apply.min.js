window.onload = () => {
    var lstApply = document.querySelectorAll('.apply')
    lstApply.forEach((element)=>{
        element.addEventListener('click',()=>{
            applyBill(element.parentElement.parentElement.getAttribute('data-id'),'1')
        })
    })
    var lstApply = document.querySelectorAll('.cancel')
    lstApply.forEach((element)=>{
        element.addEventListener('click',()=>{
            applyBill(element.parentElement.parentElement.getAttribute('data-id'),'2')
        })
    })
    const applyBill = async (id,status)=>{
        LoadingStatus(true)
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        var data = await fetch(`/apply?id=${id}&status=${status}`, requestOptions)
        LoadingStatus(false)
        location.reload()
    }
    //kiểm tra thông tin 
    var lstFull = document.querySelectorAll('.check_full')
    lstFull.forEach((element)=>{
        element.addEventListener('click',()=>{
            checkFullData('full')
        })
    })
    var lstFull = document.querySelectorAll('.Ebanker')
    lstFull.forEach((element)=>{
        element.addEventListener('click',()=>{
            checkFullData('Ebanker')
        })
    })
    var lstFull = document.querySelectorAll('.Fig')
    lstFull.forEach((element)=>{
        element.addEventListener('click',()=>{
            checkFullData('Fig')
        })
    })
    var lstFull = document.querySelectorAll('.CicShb')
    lstFull.forEach((element)=>{
        element.addEventListener('click',()=>{
            checkFullData('CicShb')
        })
    })
    var lstFull = document.querySelectorAll('.Ptf')
    lstFull.forEach((element)=>{
        element.addEventListener('click',()=>{
            checkFullData('Ptf')
        })
    })
    var lstFull = document.querySelectorAll('.LotteFinance')
    lstFull.forEach((element)=>{
        element.addEventListener('click',()=>{
            checkFullData('LotteFinance')
        })
    })
    const checkFullData = async (type)=>{
        LoadingStatus(true)
        var id_person = document.querySelector('#id_person')
        var name = document.querySelector('#name')
        if(id_person.value.length < 9){
            LoadingStatus(false)
            alert("Vui lòng nhập đúng định dạng CMND|CCCD")
            return
        }
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        var data = await fetch(`/check?cccd=${id_person.value}&name=${name.value}&type=${type}`, requestOptions)
        var res = await data.json()
        document.querySelector('#result').innerHTML = res.Message
        document.querySelector('#balance').innerHTML = res.balance
        LoadingStatus(false)
    }
    const LoadingStatus = (type) =>{
        try {
            if(type){
                document.getElementsByClassName('loading')[0].style.display = 'flex';
            }else{
                document.getElementsByClassName('loading')[0].style.display = 'none';
            }
        } catch (error) {
            
        }
    }
    //check thông tin 
    const Phonenumber = document.querySelector('#Phonenumber')
    Phonenumber.addEventListener('click',async ()=>{
        var phone = Phonenumber.value
        if(phone.length >= 10){
            var requestOptions = {
                method: 'GET',
                redirect: 'follow'
            };
            var data = await fetch(`/info?phonenumber=${phone}`, requestOptions)
            var res = await data.json()
            if(res.Message== "Ok"){
                document.querySelector('#name').textContent = res.user.name
                document.querySelector('#id_person').value = res.user.id
                document.querySelector('#balancechange').value = res.user.balance
            }else{
                alert(res.Message)
            }
        }
    })
    const edit_user = document.querySelector('.edit_user')
    edit_user.addEventListener('click',async ()=>{
        var value  = document.querySelector('#balancechange').value
        var id_person  = document.querySelector('#id_person').value
        var requestOptions = {
            method: 'GET',
            redirect: 'follow'
        };
        var data = await fetch(`/edit?balance=${value}&id=${id_person}`, requestOptions)
        var res = await data.json()
        alert(res.Message)
        location.reload()
    })
}